<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초음파 센서 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .status-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .warning-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .warning-close {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        .warning-normal {
            background: #27ae60;
        }

        .warning-far {
            background: #f39c12;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            height: 500px;
        }

        .btn-custom {
            background: linear-gradient(145deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            margin: 5px;
        }

        .btn-danger-custom {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .chart-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
        }

        .sensor-mode-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .mode-simulation {
            background: #f39c12;
            color: white;
        }

        .mode-hardware {
            background: #27ae60;
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header" style="position: relative;">
            <h1><i class="fas fa-broadcast-tower"></i> 초음파 센서 대시보드</h1>
            <div class="sensor-mode-badge mode-simulation" id="sensorModeBadge">시뮬레이션 모드</div>
        </div>

        <!-- Status Display -->
        <div class="status-display">
            <div class="status-card">
                <div class="warning-indicator warning-normal" id="warningIndicator">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div>상태</div>
                <div class="status-value" style="color: #27ae60;" id="statusText">정상</div>
            </div>

            <div class="status-card">
                <div>현재 거리</div>
                <div class="status-value" style="color: #3498db;" id="currentDistance">-- cm</div>
            </div>

            <div class="status-card">
                <div>필터링된 거리</div>
                <div class="status-value" style="color: #f39c12;" id="filteredDistance">-- cm</div>
            </div>

            <div class="status-card">
                <div>측정 간격</div>
                <div class="status-value" style="color: #2c3e50;" id="intervalDisplay">1.0초</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h4><i class="fas fa-clock"></i> 측정 간격 설정</h4>
                    <label>간격: <span id="intervalValue">1.0초</span></label>
                    <input type="range" class="form-range" id="intervalRange" min="0.1" max="5" step="0.1" value="1">
                </div>

                <div class="col-md-6">
                    <h4><i class="fas fa-exclamation-triangle"></i> 경고 설정</h4>
                    <div class="row">
                        <div class="col-6">
                            <label>가까움 임계값 (cm)</label>
                            <input type="number" class="form-control" id="closeThreshold" value="10" min="1" max="999">
                        </div>
                        <div class="col-6">
                            <label>멀음 임계값 (cm)</label>
                            <input type="number" class="form-control" id="farThreshold" value="20" min="1" max="999">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center">
                <button class="btn btn-custom" id="startBtn">
                    <i class="fas fa-play"></i> 측정 시작
                </button>
                <button class="btn btn-danger-custom" id="stopBtn" disabled>
                    <i class="fas fa-stop"></i> 측정 중지
                </button>
                <button class="btn btn-custom" id="clearBtn">
                    <i class="fas fa-trash"></i> 데이터 초기화
                </button>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-controls">
                <label class="chart-checkbox">
                    <input type="checkbox" id="showRaw" checked>
                    <span><i class="fas fa-chart-line" style="color: #3498db;"></i> 실시간 측정값</span>
                </label>
                <label class="chart-checkbox">
                    <input type="checkbox" id="showFiltered" checked>
                    <span><i class="fas fa-chart-area" style="color: #e74c3c;"></i> 필터링된 값 (이동평균)</span>
                </label>
            </div>
            <canvas id="distanceChart"></canvas>
        </div>
    </div>

    <script>
        // 전역 변수
        let isRunning = false;
        let dataUpdateInterval;
        let distanceData = [];
        let filteredData = [];
        let timeLabels = [];
        let chart;
        let movingAverageWindow = 5;

        // DOM 요소
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            intervalRange: document.getElementById('intervalRange'),
            intervalValue: document.getElementById('intervalValue'),
            intervalDisplay: document.getElementById('intervalDisplay'),
            closeThreshold: document.getElementById('closeThreshold'),
            farThreshold: document.getElementById('farThreshold'),
            currentDistance: document.getElementById('currentDistance'),
            filteredDistance: document.getElementById('filteredDistance'),
            statusText: document.getElementById('statusText'),
            warningIndicator: document.getElementById('warningIndicator'),
            showRaw: document.getElementById('showRaw'),
            showFiltered: document.getElementById('showFiltered'),
            sensorModeBadge: document.getElementById('sensorModeBadge')
        };

        // API 통신 함수
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error(`API 호출 실패 (${endpoint}):`, error);
                return { success: false, message: '서버 통신에 실패했습니다.' };
            }
        }

        // 차트 초기화
        function initChart() {
            const ctx = document.getElementById('distanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: '실시간 측정값',
                            data: distanceData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: '필터링된 값',
                            data: filteredData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '시간별 거리 측정값'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '시간'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '거리 (cm)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 이동평균 계산
        function calculateMovingAverage(data, window) {
            if (data.length < window) return data[data.length - 1] || 0;
            const slice = data.slice(-window);
            return slice.reduce((sum, val) => sum + val, 0) / window;
        }

        // 경고 상태 업데이트
        function updateWarningStatus(status) {
            let statusText, indicatorClass, color;

            switch(status) {
                case 'close':
                    statusText = '가까움';
                    indicatorClass = 'warning-close';
                    color = '#e74c3c';
                    break;
                case 'far':
                    statusText = '멀음';
                    indicatorClass = 'warning-far';
                    color = '#f39c12';
                    break;
                default:
                    statusText = '정상';
                    indicatorClass = 'warning-normal';
                    color = '#27ae60';
            }

            elements.statusText.textContent = statusText;
            elements.statusText.style.color = color;
            elements.warningIndicator.className = `warning-indicator ${indicatorClass}`;
        }

        // 데이터 업데이트
        function updateData(readings) {
            // 기존 데이터 초기화
            distanceData.length = 0;
            filteredData.length = 0;
            timeLabels.length = 0;

            // 새 데이터로 업데이트
            readings.forEach(reading => {
                distanceData.push(reading.distance);
                timeLabels.push(reading.timestamp);
            });

            // 필터링된 데이터 계산
            distanceData.forEach((_, index) => {
                const slice = distanceData.slice(0, index + 1);
                const windowSize = Math.min(movingAverageWindow, slice.length);
                const filtered = calculateMovingAverage(slice.slice(-windowSize), windowSize);
                filteredData.push(filtered);
            });

            // 최신 데이터로 UI 업데이트
            if (readings.length > 0) {
                const latest = readings[readings.length - 1];
                elements.currentDistance.textContent = latest.distance.toFixed(1) + ' cm';
                elements.filteredDistance.textContent = filteredData[filteredData.length - 1].toFixed(1) + ' cm';
                updateWarningStatus(latest.status);
            }

            updateChart();
        }

        // 차트 업데이트
        function updateChart() {
            chart.data.datasets[0].hidden = !elements.showRaw.checked;
            chart.data.datasets[1].hidden = !elements.showFiltered.checked;
            chart.update('none');
        }

        // 실시간 데이터 가져오기
        async function fetchData() {
            const result = await apiCall('data');
            if (result.success && result.data) {
                updateData(result.data);
                isRunning = result.is_running;
                updateButtonStates();
            }
        }

        // 시스템 상태 가져오기
        async function fetchStatus() {
            const result = await apiCall('status');
            if (result.success) {
                const { system } = result;

                // 센서 모드 표시
                const badge = elements.sensorModeBadge;
                if (system.sensor_mode === 'simulation') {
                    badge.textContent = '시뮬레이션 모드';
                    badge.className = 'sensor-mode-badge mode-simulation';
                } else {
                    badge.textContent = '하드웨어 모드';
                    badge.className = 'sensor-mode-badge mode-hardware';
                }

                isRunning = system.is_running;
                updateButtonStates();
            }
        }

        // 버튼 상태 업데이트
        function updateButtonStates() {
            elements.startBtn.disabled = isRunning;
            elements.stopBtn.disabled = !isRunning;
        }

        // 측정 시작
        async function startMeasurement() {
            const result = await apiCall('start', 'POST');
            if (result.success) {
                isRunning = true;
                updateButtonStates();
                // 현재 설정된 간격에 맞춰 실시간 데이터 업데이트 시작
                const intervalMs = parseFloat(elements.intervalRange.value) * 1000;
                dataUpdateInterval = setInterval(fetchData, Math.max(100, intervalMs)); // 최소 100ms
                console.log(`측정이 시작되었습니다. 업데이트 간격: ${intervalMs}ms`);
            } else {
                alert(result.message || '측정 시작에 실패했습니다.');
            }
        }

        // 측정 중지
        async function stopMeasurement() {
            const result = await apiCall('stop', 'POST');
            if (result.success) {
                isRunning = false;
                updateButtonStates();
                // 실시간 데이터 업데이트 중지
                if (dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                    dataUpdateInterval = null;
                }
                console.log('측정이 중지되었습니다.');
            } else {
                alert(result.message || '측정 중지에 실패했습니다.');
            }
        }

        // 데이터 초기화
        async function clearData() {
            const result = await apiCall('clear', 'POST');
            if (result.success) {
                distanceData.length = 0;
                filteredData.length = 0;
                timeLabels.length = 0;

                elements.currentDistance.textContent = '-- cm';
                elements.filteredDistance.textContent = '-- cm';
                elements.statusText.textContent = '정상';
                elements.statusText.style.color = '#27ae60';
                elements.warningIndicator.className = 'warning-indicator warning-normal';

                chart.update();
                console.log('데이터가 초기화되었습니다.');
            } else {
                alert(result.message || '데이터 초기화에 실패했습니다.');
            }
        }

        // 설정 업데이트
        async function updateConfig() {
            const config = {
                interval: parseFloat(elements.intervalRange.value),
                close_threshold: parseFloat(elements.closeThreshold.value),
                far_threshold: parseFloat(elements.farThreshold.value)
            };

            const result = await apiCall('config', 'POST', config);
            if (result.success) {
                // 측정 중일 때 데이터 업데이트 간격도 변경
                if (isRunning && dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                    const intervalMs = config.interval * 1000;
                    dataUpdateInterval = setInterval(fetchData, Math.max(100, intervalMs)); // 최소 100ms
                    console.log(`설정이 업데이트되었습니다. 새 업데이트 간격: ${intervalMs}ms`);
                } else {
                    console.log('설정이 업데이트되었습니다.');
                }
            } else {
                alert(result.message || '설정 업데이트에 실패했습니다.');
            }
        }

        // 간격 변경 처리
        function updateInterval() {
            const value = parseFloat(elements.intervalRange.value);
            elements.intervalValue.textContent = value.toFixed(1) + '초';
            elements.intervalDisplay.textContent = value.toFixed(1) + '초';
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            elements.startBtn.addEventListener('click', startMeasurement);
            elements.stopBtn.addEventListener('click', stopMeasurement);
            elements.clearBtn.addEventListener('click', clearData);
            elements.intervalRange.addEventListener('input', updateInterval);
            elements.intervalRange.addEventListener('change', updateConfig);
            elements.closeThreshold.addEventListener('change', updateConfig);
            elements.farThreshold.addEventListener('change', updateConfig);
            elements.showRaw.addEventListener('change', updateChart);
            elements.showFiltered.addEventListener('change', updateChart);
        }

        // 초기화
        async function init() {
            initChart();
            setupEventListeners();
            updateInterval();

            // 초기 상태 로드
            await fetchStatus();
            await fetchData();

            console.log('초음파 센서 대시보드 초기화 완료');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);

        // 페이지 언로드 시 측정 중지
        window.addEventListener('beforeunload', () => {
            if (isRunning) {
                apiCall('stop', 'POST');
            }
        });
    </script>
</body>
</html>