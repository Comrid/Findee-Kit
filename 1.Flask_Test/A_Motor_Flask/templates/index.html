<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinder Motor Control Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 1fr 80px;
            grid-template-areas:
                "header header"
                "camera controls"
                "footer footer";
            height: 100vh;
            gap: 15px;
            padding: 15px;
        }

        /* Header */
        .header {
            grid-area: header;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Camera Area */
        .camera-container {
            grid-area: camera;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #1a1a1a;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
        }

        .camera-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Controls Panel */
        .controls-panel {
            grid-area: controls;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .controls-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Direction Pad */
        .direction-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            max-width: 240px;
            margin: 0 auto;
        }

        .direction-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid transparent;
        }

        .direction-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .direction-btn:active,
        .direction-btn.active {
            background: rgba(74, 222, 128, 0.6);
            border-color: #4ade80;
            transform: scale(0.95);
        }

        .direction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button positions */
        .btn-forward-left { grid-column: 1; grid-row: 1; }
        .btn-forward { grid-column: 2; grid-row: 1; }
        .btn-forward-right { grid-column: 3; grid-row: 1; }
        .btn-rotate-left { grid-column: 1; grid-row: 2; }
        .btn-stop { grid-column: 2; grid-row: 2; background: rgba(239, 68, 68, 0.6); }
        .btn-rotate-right { grid-column: 3; grid-row: 2; }
        .btn-backward-left { grid-column: 1; grid-row: 3; }
        .btn-backward { grid-column: 2; grid-row: 3; }
        .btn-backward-right { grid-column: 3; grid-row: 3; }

        .btn-stop:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        /* íšŒì „ ì•„ì´ì½˜ 180ë„ íšŒì „ */
        .btn-rotate-left,
        .btn-rotate-right {
            transform: rotate(180deg);
        }

        .btn-rotate-left:hover,
        .btn-rotate-right:hover {
            transform: rotate(180deg) scale(1.05);
        }

        .btn-rotate-left:active,
        .btn-rotate-left.active,
        .btn-rotate-right:active,
        .btn-rotate-right.active {
            transform: rotate(180deg) scale(0.95);
        }

        /* Speed Control */
        .speed-control {
            text-align: center;
        }

        .speed-label {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            display: block;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .speed-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .speed-value {
            margin-top: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #4ade80;
        }

        .speed-range {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Log Panel */
        .log-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-header h4 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .log-clear-btn {
            background: rgba(239, 68, 68, 0.6);
            border: none;
            color: #fff;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .log-clear-btn:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .log-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            max-height: 610px;
            min-height: 600px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-item {
            margin-bottom: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            word-wrap: break-word;
        }

        .log-item.system {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        .log-item.command {
            background: rgba(34, 197, 94, 0.2);
            border-left: 3px solid #22c55e;
        }

        .log-item.warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 3px solid #f59e0b;
        }

        .log-item.error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 3px solid #ef4444;
        }

        .log-timestamp {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        /* Footer */
        .footer {
            grid-area: footer;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .keyboard-hints {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .key {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Connection Status */
        .connection-status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 300px 80px;
                grid-template-areas:
                    "header"
                    "camera"
                    "controls"
                    "footer";
            }

            .direction-pad {
                max-width: 200px;
            }

            .direction-btn {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
        }
    </style>
    <!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ğŸ¤– Robot Control Dashboard</h1>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
                <div class="status-item">
                    <span>ğŸ“¶ WiFi: 85%</span>
                </div>
                <div class="status-item">
                    <span>ğŸ”‹ Battery: 78%</span>
                </div>
            </div>
        </header>

        <!-- Camera Feed -->
        <div class="camera-container">
            <div class="connection-status">ğŸ“¹ Camera Feed</div>
            <!-- ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” WebRTC ë˜ëŠ” MJPEG ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´ -->
            <div class="camera-overlay">
                <div class="camera-icon">ğŸ“¹</div>
                <div>Camera Feed</div>
                <div style="font-size: 12px; opacity: 0.7;">ì‹¤ì‹œê°„ ì˜ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3 class="controls-title">Motor Control</h3>

            <!-- Direction Pad -->
            <div class="direction-pad">
                <button class="direction-btn btn-forward-left" data-direction="forward-left" title="ì „ì§„+ì¢ŒíšŒì „">â†–</button>
                <button class="direction-btn btn-forward" data-direction="forward" title="ì „ì§„">â†‘</button>
                <button class="direction-btn btn-forward-right" data-direction="forward-right" title="ì „ì§„+ìš°íšŒì „">â†—</button>

                <button class="direction-btn btn-rotate-left" data-direction="rotate-left" title="ì œìë¦¬ ì¢ŒíšŒì „">â†º</button>
                <button class="direction-btn btn-stop" data-direction="stop" title="ì •ì§€">â¹</button>
                <button class="direction-btn btn-rotate-right" data-direction="rotate-right" title="ì œìë¦¬ ìš°íšŒì „">â†»</button>

                <button class="direction-btn btn-backward-left" data-direction="backward-left" title="í›„ì§„+ì¢ŒíšŒì „">â†™</button>
                <button class="direction-btn btn-backward" data-direction="backward" title="í›„ì§„">â†“</button>
                <button class="direction-btn btn-backward-right" data-direction="backward-right" title="í›„ì§„+ìš°íšŒì „">â†˜</button>
            </div>

            <!-- Speed Control -->
            <div class="speed-control">
                <label class="speed-label">ì†ë„ ì¡°ì ˆ</label>
                <input type="range" class="speed-slider" id="speedSlider" min="20" max="100" value="60">
                <div class="speed-value" id="speedValue">60%</div>
                <div class="speed-range">
                    <span>20%</span>
                    <span>100%</span>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="log-panel">
                <div class="log-header">
                    <h4>Activity Log</h4>
                    <button class="log-clear-btn" id="clearLogBtn">Clear</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-item system">ğŸš€ Robot Control Dashboard initialized</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="keyboard-hints">
                <div class="hint-item">
                    <span class="key">â†‘â†“â†â†’</span>
                    <span>ê¸°ë³¸ ì¡°ì‘</span>
                </div>
                <div class="hint-item">
                    <span class="key">â†‘+â†</span><span class="key">â†‘+â†’</span>
                    <span>ì „ì§„ ëŒ€ê°ì„ </span>
                </div>
                <div class="hint-item">
                    <span class="key">â†“+â†</span><span class="key">â†“+â†’</span>
                    <span>í›„ì§„ ëŒ€ê°ì„ </span>
                </div>
                <div class="hint-item">
                    <span class="key">Space</span>
                    <span>ì •ì§€</span>
                </div>
                <div class="hint-item">
                    <span class="key">+/-</span>
                    <span>ì†ë„ ì¡°ì ˆ</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        class RobotController {
            constructor() {
                this.currentSpeed = 60;
                this.activeButtons = new Set();
                this.pressedKeys = new Set();
                this.keyPressOrder = []; // í‚¤ ëˆ„ë¥¸ ìˆœì„œ ì¶”ì 
                this.isConnected = false;
                this.speedAdjustInterval = null;
                this.speedAdjustDelay = 30; // ì—°ì† ì¡°ì ˆ ê°„ê²© (ms)
                this.speedAdjustAcceleration = {
                    initialDelay: 100, // ì´ˆê¸° ê°„ê²© (ms)
                    minDelay: 20,      // ìµœì†Œ ê°„ê²© (ms)
                    acceleration: 0.9,  // ê°€ì† ë¹„ìœ¨ (ë‚®ì„ìˆ˜ë¡ ë¹¨ë¼ì§)
                    currentDelay: 100
                }

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupSpeedControl();
                this.setupSocketConnection();
                this.setupLogPanel();

                // ì´ˆê¸° ì—°ê²° ì‹œë®¬ë ˆì´ì…˜
                setTimeout(() => {
                    this.isConnected = true;
                    this.addLog('ğŸ¤– Robot connected successfully!', 'system');
                }, 1000);
            }

            setupEventListeners() {
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
                document.querySelectorAll('.direction-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => this.handleButtonPress(e.target));
                    btn.addEventListener('mouseup', (e) => this.handleButtonRelease(e.target));
                    btn.addEventListener('mouseleave', (e) => this.handleButtonRelease(e.target));
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.handleButtonPress(e.target);
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.handleButtonRelease(e.target);
                    });
                });

                // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));

                // í¬ì»¤ìŠ¤ ìœ ì§€
                document.addEventListener('click', () => document.body.focus());
                document.body.tabIndex = 0;
            }

            setupSpeedControl() {
                const speedSlider = document.getElementById('speedSlider');
                const speedValue = document.getElementById('speedValue');

                speedSlider.addEventListener('input', (e) => {
                    this.currentSpeed = parseInt(e.target.value);
                    speedValue.textContent = `${this.currentSpeed}%`;

                    // ì„œë²„ì— ì†ë„ ë³€ê²½ ì•Œë¦¼
                    if (this.socket) {
                        this.socket.emit('set_speed', { speed: this.currentSpeed });
                    }

                    // í˜„ì¬ ì´ë™ ì¤‘ì´ë©´ ì†ë„ ì—…ë°ì´íŠ¸
                    if (this.activeButtons.size > 0) {
                        this.updateMotorCommand();
                    }
                });
            }

            setupSocketConnection() {
                // Socket.IO ì—°ê²°
                this.socket = io();

                // ì—°ê²° ì´ë²¤íŠ¸
                this.socket.on('connect', () => {
                    this.addLog('ğŸ”Œ Socket connected to server', 'system');
                    this.isConnected = true;
                });

                this.socket.on('disconnect', () => {
                    this.addLog('ğŸ”Œ Socket disconnected from server', 'warning');
                    this.isConnected = false;
                });

                // ì„œë²„ ì‘ë‹µ ì´ë²¤íŠ¸
                this.socket.on('connection_status', (data) => {
                    this.isConnected = data.connected;
                    this.addLog(`ğŸ“¡ ${data.message}`, data.connected ? 'system' : 'warning');
                });

                this.socket.on('robot_status', (data) => {
                    this.currentSpeed = data.speed;
                    document.getElementById('speedSlider').value = data.speed;
                    document.getElementById('speedValue').textContent = `${data.speed}%`;
                    this.addLog(`ğŸ¤– Robot status: ${data.direction} at ${data.speed}%`, 'system');
                });

                this.socket.on('motor_feedback', (data) => {
                    if (data.success) {
                        this.addLog(`âœ… Motor: ${data.direction} (${data.speed}%)`, 'command');
                    } else {
                        this.addLog(`âŒ Motor command failed: ${data.direction}`, 'error');
                    }
                });

                this.socket.on('speed_updated', (data) => {
                    this.addLog(`âš¡ Speed updated: ${data.speed}%`, 'system');
                });

                this.socket.on('distance_update', (data) => {
                    this.addLog(`ğŸ“ Distance: ${data.distance.toFixed(1)}cm`, 'system');
                });

                this.socket.on('camera_frame', (data) => {
                    // ì¹´ë©”ë¼ í”„ë ˆì„ ì—…ë°ì´íŠ¸
                    const cameraFeed = document.querySelector('.camera-feed');
                    const cameraOverlay = document.querySelector('.camera-overlay');

                    if (cameraFeed && data.image) {
                        if (!cameraFeed.src) {
                            // ì²˜ìŒ ì¹´ë©”ë¼ í”„ë ˆì„ì´ ì˜¤ë©´ overlay ìˆ¨ê¸°ê¸°
                            if (cameraOverlay) cameraOverlay.style.display = 'none';

                            // img íƒœê·¸ ìƒì„±
                            const img = document.createElement('img');
                            img.className = 'camera-feed';
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            cameraFeed.parentNode.appendChild(img);
                        }

                        const img = document.querySelector('img.camera-feed');
                        if (img) {
                            img.src = `data:image/jpeg;base64,${data.image}`;
                        }
                    }
                });

                this.socket.on('emergency_stop_confirmed', (data) => {
                    this.addLog('ğŸš¨ Emergency stop executed!', 'error');
                });

                this.addLog('ğŸ”Œ Socket connection initialized', 'system');
            }

            setupLogPanel() {
                const clearBtn = document.getElementById('clearLogBtn');
                clearBtn.addEventListener('click', () => {
                    this.clearLog();
                });
            }

            handleButtonPress(button) {
                const direction = button.dataset.direction;
                if (!direction || this.activeButtons.has(direction)) return;

                this.activeButtons.add(direction);
                button.classList.add('active');
                this.sendMotorCommand(direction);

                this.addLog(`ğŸ® Button pressed: ${direction} at ${this.currentSpeed}% speed`, 'command');
            }

            handleButtonRelease(button) {
                const direction = button.dataset.direction;
                if (!direction || !this.activeButtons.has(direction)) return;

                this.activeButtons.delete(direction);
                button.classList.remove('active');

                if (this.activeButtons.size === 0) {
                    this.sendMotorCommand('stop');
                } else {
                    this.updateMotorCommand();
                }

                this.addLog(`ğŸ® Button released: ${direction}`, 'command');
            }

            handleKeyDown(e) {
                // ì†ë„ ì¡°ì ˆ í‚¤ ì²˜ë¦¬
                if (e.key === '+' || e.key === '=') {
                    this.startSpeedAdjustment(1);
                    e.preventDefault();
                    return;
                } else if (e.key === '-') {
                    this.startSpeedAdjustment(-1);
                    e.preventDefault();
                    return;
                }

                // ë°©í–¥í‚¤ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) return;

                // ì´ë¯¸ ëˆŒë¦° í‚¤ë©´ ë¬´ì‹œ
                if (this.pressedKeys.has(e.code)) return;

                this.pressedKeys.add(e.code);
                this.keyPressOrder.push(e.code);

                this.updateDirectionFromKeys();
                e.preventDefault();
            }

            handleKeyUp(e) {
                // ì†ë„ ì¡°ì ˆ í‚¤ë¥¼ ë—ì„ ë•Œ ì—°ì† ì¡°ì ˆ ì¤‘ì§€
                if (e.key === '+' || e.key === '=' || e.key === '-') {
                    this.stopSpeedAdjustment();
                    return;
                }

                // ë°©í–¥í‚¤ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) return;

                this.pressedKeys.delete(e.code);
                this.keyPressOrder = this.keyPressOrder.filter(key => key !== e.code);

                this.updateDirectionFromKeys();
            }

            updateDirectionFromKeys() {
                const newDirection = this.getDirectionFromKeys();
                const currentDirection = Array.from(this.activeButtons)[0] || null;

                // ë°©í–¥ì´ ë°”ë€Œë©´ ì´ì „ ë²„íŠ¼ í•´ì œ
                if (currentDirection && currentDirection !== newDirection) {
                    const oldButton = document.querySelector(`[data-direction="${currentDirection}"]`);
                    if (oldButton) this.handleButtonRelease(oldButton);
                }

                // ìƒˆ ë°©í–¥ì´ ìˆìœ¼ë©´ ë²„íŠ¼ ëˆ„ë¥´ê¸°
                if (newDirection && newDirection !== currentDirection) {
                    const newButton = document.querySelector(`[data-direction="${newDirection}"]`);
                    if (newButton) this.handleButtonPress(newButton);
                }
            }

            getDirectionFromKeys() {
                const up = this.pressedKeys.has('ArrowUp');
                const down = this.pressedKeys.has('ArrowDown');
                const left = this.pressedKeys.has('ArrowLeft');
                const right = this.pressedKeys.has('ArrowRight');
                const stop = this.pressedKeys.has('Space');

                if (stop) return 'stop';

                // ê°€ì¥ ìµœê·¼ì— ëˆŒë¦° í‚¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš°ì„ ìˆœìœ„ ê²°ì •
                const lastKey = this.keyPressOrder[this.keyPressOrder.length - 1];

                // 8ë°©í–¥ ì¡°í•© (ëŒ€ê°ì„  ì´ë™) - ë§ˆì§€ë§‰ í‚¤ ê¸°ì¤€
                if (up && left) {
                    return lastKey === 'ArrowUp' ? 'forward-left' : 'forward-left';
                }
                if (up && right) {
                    return lastKey === 'ArrowUp' ? 'forward-right' : 'forward-right';
                }
                if (down && left) {
                    return lastKey === 'ArrowDown' ? 'backward-left' : 'backward-left';
                }
                if (down && right) {
                    return lastKey === 'ArrowDown' ? 'backward-right' : 'backward-right';
                }

                // ë‹¨ì¼ ë°©í–¥ - ë§ˆì§€ë§‰ì— ëˆ„ë¥¸ í‚¤ ìš°ì„ 
                if (lastKey === 'ArrowUp' && up) return 'forward';
                if (lastKey === 'ArrowDown' && down) return 'backward';
                if (lastKey === 'ArrowLeft' && left) return 'rotate-left';
                if (lastKey === 'ArrowRight' && right) return 'rotate-right';

                // ë§ˆì§€ë§‰ í‚¤ê°€ ì—†ê±°ë‚˜ í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ìˆœì„œ
                if (up) return 'forward';
                if (down) return 'backward';
                if (left) return 'rotate-left';
                if (right) return 'rotate-right';

                return null;
            }

            adjustSpeed(delta) {
                const newSpeed = Math.max(20, Math.min(100, this.currentSpeed + delta));
                document.getElementById('speedSlider').value = newSpeed;
                document.getElementById('speedSlider').dispatchEvent(new Event('input'));
            }

            startSpeedAdjustment(delta) {
                // ì´ë¯¸ ì¡°ì ˆ ì¤‘ì´ë©´ ì¤‘ì§€
                if (this.speedAdjustInterval) {
                    this.stopSpeedAdjustment();
                }

                // ê°€ì†ë„ ì´ˆê¸°í™”
                this.speedAdjustAcceleration.currentDelay = this.speedAdjustAcceleration.initialDelay;

                // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                this.adjustSpeed(delta);

                // ê°€ì†ë˜ëŠ” ì—°ì† ì¡°ì ˆ ì‹œì‘
                this.scheduleNextSpeedAdjust(delta);
            }

            scheduleNextSpeedAdjust(delta) {
                this.speedAdjustInterval = setTimeout(() => {
                    this.adjustSpeed(delta);

                    // ê°„ê²©ì„ ì ì  ì¤„ì—¬ì„œ ê°€ì†
                    this.speedAdjustAcceleration.currentDelay = Math.max(
                        this.speedAdjustAcceleration.minDelay,
                        this.speedAdjustAcceleration.currentDelay * this.speedAdjustAcceleration.acceleration
                    );

                    // ë‹¤ìŒ ì¡°ì ˆ ì˜ˆì•½
                    this.scheduleNextSpeedAdjust(delta);
                }, this.speedAdjustAcceleration.currentDelay);
            }

            stopSpeedAdjustment() {
                if (this.speedAdjustInterval) {
                    clearTimeout(this.speedAdjustInterval);
                    this.speedAdjustInterval = null;
                }
                // ê°€ì†ë„ ì´ˆê¸°í™”
                this.speedAdjustAcceleration.currentDelay = this.speedAdjustAcceleration.initialDelay;
            }

            updateMotorCommand() {
                if (this.activeButtons.size > 0) {
                    const direction = Array.from(this.activeButtons)[0];
                    this.sendMotorCommand(direction);
                }
            }

            sendMotorCommand(direction) {
                if (!this.isConnected) {
                    this.addLog('ğŸš« Robot not connected', 'warning');
                    return;
                }

                const command = {
                    direction: direction,
                    speed: this.currentSpeed,
                    timestamp: Date.now()
                };

                // Socket.IOë¡œ ëª¨í„° ì œì–´ ëª…ë ¹ ì „ì†¡
                if (this.socket) {
                    this.socket.emit('motor_control', command);
                    this.addLog(`ğŸ“¡ Sent: ${direction} (${this.currentSpeed}%)`, 'command');
                } else {
                    this.addLog('ğŸš« Socket not available', 'error');
                }

                // ì‹œê°ì  í”¼ë“œë°±
                this.showCommandFeedback(direction);
            }

            showCommandFeedback(direction) {
                // ê°„ë‹¨í•œ ì‹œê°ì  í”¼ë“œë°±
                const directionNames = {
                    'forward': 'â¬†ï¸ ì „ì§„',
                    'backward': 'â¬‡ï¸ í›„ì§„',
                    'forward-left': 'â†–ï¸ ì „ì§„+ì¢ŒíšŒì „',
                    'forward-right': 'â†—ï¸ ì „ì§„+ìš°íšŒì „',
                    'backward-left': 'â†™ï¸ í›„ì§„+ì¢ŒíšŒì „',
                    'backward-right': 'â†˜ï¸ í›„ì§„+ìš°íšŒì „',
                    'rotate-left': 'â†º ì œìë¦¬ ì¢ŒíšŒì „',
                    'rotate-right': 'â†» ì œìë¦¬ ìš°íšŒì „',
                    'stop': 'â¹ï¸ ì •ì§€'
                };

                // ë¡œê·¸ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë„ˆë¬´ ë§ì€ ë©”ì‹œì§€ ë°©ì§€)
            }

            addLog(message, type = 'system') {
                const logContent = document.getElementById('logContent');
                const logItem = document.createElement('div');
                logItem.className = `log-item ${type}`;

                const timestamp = new Date().toLocaleTimeString();
                logItem.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span> ${message}
                `;

                logContent.appendChild(logItem);

                // ìë™ ìŠ¤í¬ë¡¤ (ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ë„ë¡)
                logContent.scrollTop = logContent.scrollHeight;

                // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±° (ìµœëŒ€ 100ê°œ)
                const logItems = logContent.querySelectorAll('.log-item');
                if (logItems.length > 100) {
                    logItems[0].remove();
                }
            }

            clearLog() {
                const logContent = document.getElementById('logContent');
                logContent.innerHTML = '';
                this.addLog('ğŸ“ Log cleared', 'system');
            }
        }

        // ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const controller = new RobotController();

            // ê¸€ë¡œë²Œ ê°ì²´ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (ë””ë²„ê¹…ìš©)
            window.robotController = controller;

            setTimeout(() => {
                controller.addLog('ğŸ“– ì‚¬ìš©ë²•:', 'system');
                controller.addLog('   - ë§ˆìš°ìŠ¤: ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì¡°ì‘', 'system');
                controller.addLog('   - í‚¤ë³´ë“œ: í™”ì‚´í‘œí‚¤, Space(ì •ì§€), +/-(ì†ë„)', 'system');
                controller.addLog('   - F1: ê±°ë¦¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘/ì¤‘ì§€', 'system');
                controller.addLog('   - F2: ì¹´ë©”ë¼ ì‹œì‘/ì¤‘ì§€', 'system');
            }, 100);

            // ì¶”ê°€ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F1') {
                    e.preventDefault();
                    if (controller.socket) {
                        if (controller.distanceMonitoring) {
                            controller.socket.emit('stop_distance_monitoring');
                            controller.distanceMonitoring = false;
                            controller.addLog('ğŸ“ Distance monitoring stopped', 'system');
                        } else {
                            controller.socket.emit('start_distance_monitoring');
                            controller.distanceMonitoring = true;
                            controller.addLog('ğŸ“ Distance monitoring started', 'system');
                        }
                    }
                } else if (e.key === 'F2') {
                    e.preventDefault();
                    if (controller.socket) {
                        if (controller.cameraActive) {
                            controller.socket.emit('stop_camera');
                            controller.cameraActive = false;
                            controller.addLog('ğŸ“¹ Camera stopped', 'system');
                        } else {
                            controller.socket.emit('start_camera');
                            controller.cameraActive = true;
                            controller.addLog('ğŸ“¹ Camera started', 'system');
                        }
                    }
                }
            });

            // ê±°ë¦¬ ëª¨ë‹ˆí„°ë§ ë° ì¹´ë©”ë¼ ìƒíƒœ ì´ˆê¸°í™”
            controller.distanceMonitoring = false;
            controller.cameraActive = false;
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (window.robotController) {
                window.robotController.sendMotorCommand('stop');
                window.robotController.stopSpeedAdjustment();
            }
        });
    </script>
</body>
</html>