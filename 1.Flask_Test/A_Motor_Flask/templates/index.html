<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Findee Robot Control Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 80px 1fr 80px;
            grid-template-areas:
                "header header"
                "camera controls"
                "footer footer";
            height: 100vh;
            gap: 15px;
            padding: 15px;
        }

        /* Header */
        .header {
            grid-area: header;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-dot.warning {
            background: #f59e0b;
        }

        .status-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Camera Area */
        .camera-container {
            grid-area: camera;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #1a1a1a;
            position: relative;
        }

        .camera-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 3;
        }

        /* Controls Panel */
        .controls-panel {
            grid-area: controls;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .controls-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Robot Status */
        .robot-status {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .status-card .label {
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .status-card .value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Direction Pad */
        .direction-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            max-width: 240px;
            margin: 0 auto;
        }

        .direction-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid transparent;
        }

        .direction-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .direction-btn:active,
        .direction-btn.active {
            background: rgba(74, 222, 128, 0.6);
            border-color: #4ade80;
            transform: scale(0.95);
        }

        .direction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button positions */
        .btn-forward-left { grid-column: 1; grid-row: 1; }
        .btn-forward { grid-column: 2; grid-row: 1; }
        .btn-forward-right { grid-column: 3; grid-row: 1; }
        .btn-rotate-left { grid-column: 1; grid-row: 2; }
        .btn-stop { grid-column: 2; grid-row: 2; background: rgba(239, 68, 68, 0.6); }
        .btn-rotate-right { grid-column: 3; grid-row: 2; }
        .btn-backward-left { grid-column: 1; grid-row: 3; }
        .btn-backward { grid-column: 2; grid-row: 3; }
        .btn-backward-right { grid-column: 3; grid-row: 3; }

        .btn-stop:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        /* Speed Control */
        .speed-control {
            text-align: center;
        }

        .speed-label {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            display: block;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .speed-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .speed-value {
            margin-top: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #4ade80;
        }

        .speed-range {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Log Panel */
        .log-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-header h4 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .log-clear-btn {
            background: rgba(239, 68, 68, 0.6);
            border: none;
            color: #fff;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .log-clear-btn:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .log-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            min-height: 250px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        .log-item {
            margin-bottom: 4px;
            padding: 3px 6px;
            border-radius: 4px;
            word-wrap: break-word;
        }

        .log-item.system {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        .log-item.command {
            background: rgba(34, 197, 94, 0.2);
            border-left: 3px solid #22c55e;
        }

        .log-item.warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 3px solid #f59e0b;
        }

        .log-item.error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 3px solid #ef4444;
        }

        .log-timestamp {
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
        }

        /* Footer */
        .footer {
            grid-area: footer;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .keyboard-hints {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .key {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 350px 80px;
                grid-template-areas:
                    "header"
                    "camera"
                    "controls"
                    "footer";
            }

            .direction-pad {
                max-width: 200px;
            }

            .direction-btn {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }

            .log-content {
                max-height: 200px;
                min-height: 150px;
            }
        }
    </style>
    <!-- Socket.IO ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ü§ñ Findee Robot Dashboard</h1>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-item">
                    <span id="networkInfo">üì∂ Network: --</span>
                </div>
                <div class="status-item">
                    <span id="systemInfo">üîã System: --</span>
                </div>
            </div>
        </header>

        <!-- Camera Feed -->
        <div class="camera-container">
            <div class="camera-info" id="cameraInfo">üìπ Camera: Active</div>
            <img src="/video_feed" alt="Camera Feed" class="camera-feed" id="cameraStream"
                 onerror="this.style.display='none'; document.getElementById('cameraError').style.display='flex';">

            <!-- Ïπ¥Î©îÎùº Ïò§Î•ò Ïãú ÌëúÏãúÌï† Ïò§Î≤ÑÎ†àÏù¥ -->
            <div id="cameraError" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                                         background: rgba(0, 0, 0, 0.5); color: white; text-align: center;
                                         display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px;">
                <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 50%;
                           display: flex; align-items: center; justify-content: center; font-size: 24px;">üìπ</div>
                <div>Camera Not Available</div>
                <div style="font-size: 12px; opacity: 0.7;">Ïπ¥Î©îÎùº Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3 class="controls-title">Robot Control</h3>

            <!-- Robot Status -->
            <div class="robot-status" id="robotStatus">
                <div class="status-card">
                    <div class="label">Motor</div>
                    <div class="value" id="motorStatus">--</div>
                </div>
                <div class="status-card">
                    <div class="label">Camera</div>
                    <div class="value" id="cameraStatus">--</div>
                </div>
                <div class="status-card">
                    <div class="label">Ultrasonic</div>
                    <div class="value" id="ultrasonicStatus">--</div>
                </div>
                <div class="status-card">
                    <div class="label">FPS</div>
                    <div class="value" id="fpsStatus">0</div>
                </div>
            </div>

            <!-- Direction Pad -->
            <div class="direction-pad">
                <button class="direction-btn btn-forward-left" data-direction="forward-left" title="Ï†ÑÏßÑ+Ï¢åÌöåÏ†Ñ">‚Üñ</button>
                <button class="direction-btn btn-forward" data-direction="forward" title="Ï†ÑÏßÑ">‚Üë</button>
                <button class="direction-btn btn-forward-right" data-direction="forward-right" title="Ï†ÑÏßÑ+Ïö∞ÌöåÏ†Ñ">‚Üó</button>

                <button class="direction-btn btn-rotate-left" data-direction="rotate-left" title="Ï†úÏûêÎ¶¨ Ï¢åÌöåÏ†Ñ">‚Ü∫</button>
                <button class="direction-btn btn-stop" data-direction="stop" title="Ï†ïÏßÄ">‚èπ</button>
                <button class="direction-btn btn-rotate-right" data-direction="rotate-right" title="Ï†úÏûêÎ¶¨ Ïö∞ÌöåÏ†Ñ">‚Üª</button>

                <button class="direction-btn btn-backward-left" data-direction="backward-left" title="ÌõÑÏßÑ+Ï¢åÌöåÏ†Ñ">‚Üô</button>
                <button class="direction-btn btn-backward" data-direction="backward" title="ÌõÑÏßÑ">‚Üì</button>
                <button class="direction-btn btn-backward-right" data-direction="backward-right" title="ÌõÑÏßÑ+Ïö∞ÌöåÏ†Ñ">‚Üò</button>
            </div>

            <!-- Speed Control -->
            <div class="speed-control">
                <label class="speed-label">ÏÜçÎèÑ Ï°∞Ï†à</label>
                <input type="range" class="speed-slider" id="speedSlider" min="20" max="100" value="60">
                <div class="speed-value" id="speedValue">60%</div>
                <div class="speed-range">
                    <span>20%</span>
                    <span>100%</span>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="log-panel">
                <div class="log-header">
                    <h4>Activity Log</h4>
                    <button class="log-clear-btn" id="clearLogBtn">Clear</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-item system">üöÄ Findee Robot Dashboard initialized</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="keyboard-hints">
                <div class="hint-item">
                    <span class="key">‚Üë‚Üì‚Üê‚Üí</span>
                    <span>Í∏∞Î≥∏ Ï°∞Ïûë</span>
                </div>
                <div class="hint-item">
                    <span class="key">Space</span>
                    <span>Ï†ïÏßÄ</span>
                </div>
                <div class="hint-item">
                    <span class="key">+/-</span>
                    <span>ÏÜçÎèÑ Ï°∞Ï†à</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        class FindeeRobotController {
            constructor() {
                this.currentSpeed = 60;
                this.activeButtons = new Set();
                this.pressedKeys = new Set();
                this.keyPressOrder = [];
                this.isConnected = false;
                this.systemInfoInterval = null;

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupSpeedControl();
                this.setupSocketConnection();
                this.setupLogPanel();
                this.startSystemInfoUpdates();

                document.body.focus();
                document.body.tabIndex = 0;
            }

            setupEventListeners() {
                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
                document.querySelectorAll('.direction-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => this.handleButtonPress(e.target));
                    btn.addEventListener('mouseup', (e) => this.handleButtonRelease(e.target));
                    btn.addEventListener('mouseleave', (e) => this.handleButtonRelease(e.target));
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.handleButtonPress(e.target);
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.handleButtonRelease(e.target);
                    });
                });

                // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                document.addEventListener('click', () => document.body.focus());

                // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ïù¥Î≤§Ìä∏
                const cameraStream = document.getElementById('cameraStream');
                cameraStream.addEventListener('load', () => {
                    document.getElementById('cameraError').style.display = 'none';
                    cameraStream.style.display = 'block';
                    this.addLog('üìπ Camera stream connected', 'system');
                });

                cameraStream.addEventListener('error', () => {
                    document.getElementById('cameraError').style.display = 'flex';
                    cameraStream.style.display = 'none';
                    this.addLog('üìπ Camera stream error', 'warning');
                });
            }

            setupSpeedControl() {
                const speedSlider = document.getElementById('speedSlider');
                const speedValue = document.getElementById('speedValue');

                speedSlider.addEventListener('input', (e) => {
                    this.currentSpeed = parseInt(e.target.value);
                    speedValue.textContent = `${this.currentSpeed}%`;

                    // ÌòÑÏû¨ Ïù¥Îèô Ï§ëÏù¥Î©¥ ÏÜçÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (this.activeButtons.size > 0) {
                        this.updateMotorCommand();
                    }
                });
            }

            setupSocketConnection() {
                this.socket = io();

                // Ïó∞Í≤∞ Ïù¥Î≤§Ìä∏
                this.socket.on('connect', () => {
                    this.addLog('üîå Socket connected to server', 'system');
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                });

                this.socket.on('disconnect', () => {
                    this.addLog('üîå Socket disconnected from server', 'warning');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                });

                // ÏÑúÎ≤Ñ ÏùëÎãµ Ïù¥Î≤§Ìä∏
                this.socket.on('connection_status', (data) => {
                    this.isConnected = data.connected;
                    this.addLog(`üì° ${data.message}`, data.connected ? 'system' : 'warning');
                    this.updateConnectionStatus(data.connected);
                });

                this.socket.on('robot_status', (data) => {
                    this.updateRobotStatus(data);
                    this.currentSpeed = data.speed || this.currentSpeed;
                    document.getElementById('speedSlider').value = this.currentSpeed;
                    document.getElementById('speedValue').textContent = `${this.currentSpeed}%`;
                    this.addLog(`ü§ñ Robot connected - Motor: ${data.motor_available}, Camera: ${data.camera_available}`, 'system');
                });

                this.socket.on('motor_feedback', (data) => {
                    if (data.success) {
                        this.addLog(`‚úÖ Motor: ${data.direction} (${data.speed}%)`, 'command');
                    } else {
                        this.addLog(`‚ùå Motor error: ${data.error}`, 'error');
                    }
                });
            }

            setupLogPanel() {
                const clearBtn = document.getElementById('clearLogBtn');
                clearBtn.addEventListener('click', () => {
                    this.clearLog();
                });
            }

            startSystemInfoUpdates() {
                // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (5Ï¥àÎßàÎã§)
                this.systemInfoInterval = setInterval(() => {
                    if (this.isConnected) {
                        this.fetchSystemInfo();
                    }
                }, 5000);

                // Ï¥àÍ∏∞ Ï†ïÎ≥¥ Î°úÎìú
                setTimeout(() => {
                    this.fetchSystemInfo();
                }, 1000);
            }

            fetchSystemInfo() {
                fetch('/api/system_info')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            this.updateSystemInfo(data);
                        }
                    })
                    .catch(error => {
                        console.log('System info fetch error:', error);
                    });
            }

            updateSystemInfo(data) {
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('networkInfo').textContent = `üì∂ IP: ${data.hostname || '--'}`;

                // ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                const cpuTemp = data.cpu_temperature ? `${data.cpu_temperature.toFixed(1)}¬∞C` : '--';
                const cpuUsage = data.cpu_percent ? `${data.cpu_percent.toFixed(1)}%` : '--';
                document.getElementById('systemInfo').textContent = `üîã CPU: ${cpuUsage} / ${cpuTemp}`;

                // FPS ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('fpsStatus').textContent = data.camera_fps || 0;

                // Ïπ¥Î©îÎùº Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                const cameraInfo = document.getElementById('cameraInfo');
                if (data.camera_fps > 0) {
                    cameraInfo.textContent = `üìπ Camera: Active (${data.camera_fps} FPS)`;
                } else {
                    cameraInfo.textContent = 'üìπ Camera: Standby';
                }
            }

            handleButtonPress(button) {
                const direction = button.dataset.direction;
                if (!direction || this.activeButtons.has(direction)) return;

                this.activeButtons.add(direction);
                button.classList.add('active');
                this.sendMotorCommand(direction);
                this.addLog(`üéÆ ${direction} pressed (${this.currentSpeed}%)`, 'command');
            }

            handleButtonRelease(button) {
                const direction = button.dataset.direction;
                if (!direction || !this.activeButtons.has(direction)) return;

                this.activeButtons.delete(direction);
                button.classList.remove('active');

                if (this.activeButtons.size === 0) {
                    this.sendMotorCommand('stop');
                } else {
                    this.updateMotorCommand();
                }
            }

            handleKeyDown(e) {
                // ÏÜçÎèÑ Ï°∞Ï†à
                if (e.key === '+' || e.key === '=') {
                    this.adjustSpeed(5);
                    e.preventDefault();
                    return;
                } else if (e.key === '-') {
                    this.adjustSpeed(-5);
                    e.preventDefault();
                    return;
                }

                // Î∞©Ìñ•ÌÇ§ Ï≤òÎ¶¨
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) return;
                if (this.pressedKeys.has(e.code)) return;

                this.pressedKeys.add(e.code);
                this.keyPressOrder.push(e.code);
                this.updateDirectionFromKeys();
                e.preventDefault();
            }

            handleKeyUp(e) {
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) return;

                this.pressedKeys.delete(e.code);
                this.keyPressOrder = this.keyPressOrder.filter(key => key !== e.code);
                this.updateDirectionFromKeys();
            }

            updateDirectionFromKeys() {
                const newDirection = this.getDirectionFromKeys();
                const currentDirection = Array.from(this.activeButtons)[0] || null;

                if (currentDirection && currentDirection !== newDirection) {
                    const oldButton = document.querySelector(`[data-direction="${currentDirection}"]`);
                    if (oldButton) this.handleButtonRelease(oldButton);
                }

                if (newDirection && newDirection !== currentDirection) {
                    const newButton = document.querySelector(`[data-direction="${newDirection}"]`);
                    if (newButton) this.handleButtonPress(newButton);
                }
            }

            getDirectionFromKeys() {
                const up = this.pressedKeys.has('ArrowUp');
                const down = this.pressedKeys.has('ArrowDown');
                const left = this.pressedKeys.has('ArrowLeft');
                const right = this.pressedKeys.has('ArrowRight');
                const stop = this.pressedKeys.has('Space');

                if (stop) return 'stop';

                const lastKey = this.keyPressOrder[this.keyPressOrder.length - 1];

                // 8Î∞©Ìñ• Ï°∞Ìï©
                if (up && left) return 'forward-left';
                if (up && right) return 'forward-right';
                if (down && left) return 'backward-left';
                if (down && right) return 'backward-right';

                // Îã®Ïùº Î∞©Ìñ•
                if (lastKey === 'ArrowUp' && up) return 'forward';
                if (lastKey === 'ArrowDown' && down) return 'backward';
                if (lastKey === 'ArrowLeft' && left) return 'rotate-left';
                if (lastKey === 'ArrowRight' && right) return 'rotate-right';

                if (up) return 'forward';
                if (down) return 'backward';
                if (left) return 'rotate-left';
                if (right) return 'rotate-right';

                return null;
            }

            adjustSpeed(delta) {
                const newSpeed = Math.max(20, Math.min(100, this.currentSpeed + delta));
                document.getElementById('speedSlider').value = newSpeed;
                document.getElementById('speedSlider').dispatchEvent(new Event('input'));
            }

            updateMotorCommand() {
                if (this.activeButtons.size > 0) {
                    const direction = Array.from(this.activeButtons)[0];
                    this.sendMotorCommand(direction);
                }
            }

            sendMotorCommand(direction) {
                if (!this.isConnected) {
                    this.addLog('üö´ Robot not connected', 'warning');
                    return;
                }

                const command = {
                    direction: direction,
                    speed: this.currentSpeed,
                    timestamp: Date.now()
                };

                if (this.socket) {
                    this.socket.emit('motor_control', command);
                } else {
                    this.addLog('üö´ Socket not available', 'error');
                }
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const status = document.getElementById('connectionStatus');

                if (connected) {
                    dot.className = 'status-dot';
                    status.textContent = 'Connected';
                } else {
                    dot.className = 'status-dot error';
                    status.textContent = 'Disconnected';
                }
            }

            updateRobotStatus(data) {
                document.getElementById('motorStatus').textContent = data.motor_available ? '‚úÖ' : '‚ùå';
                document.getElementById('cameraStatus').textContent = data.camera_available ? '‚úÖ' : '‚ùå';
                document.getElementById('ultrasonicStatus').textContent = data.ultrasonic_available ? '‚úÖ' : '‚ùå';
            }

            addLog(message, type = 'system') {
                const logContent = document.getElementById('logContent');
                const logItem = document.createElement('div');
                logItem.className = `log-item ${type}`;

                const timestamp = new Date().toLocaleTimeString();
                logItem.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span> ${message}
                `;

                logContent.appendChild(logItem);
                logContent.scrollTop = logContent.scrollHeight;

                // Î°úÍ∑∏ Í∞úÏàò Ï†úÌïú
                const logItems = logContent.querySelectorAll('.log-item');
                if (logItems.length > 80) {
                    logItems[0].remove();
                }
            }

            clearLog() {
                const logContent = document.getElementById('logContent');
                logContent.innerHTML = '';
                this.addLog('üìù Log cleared', 'system');
            }
        }

        // Ïï± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            const controller = new FindeeRobotController();
            window.robotController = controller;

            setTimeout(() => {
                controller.addLog('üìñ ÏÇ¨Ïö©Î≤ï:', 'system');
                controller.addLog('   - ÎßàÏö∞Ïä§: Î≤ÑÌäº ÌÅ¥Î¶≠ÏúºÎ°ú Ï°∞Ïûë', 'system');
                controller.addLog('   - ÌÇ§Î≥¥Îìú: ÌôîÏÇ¥ÌëúÌÇ§, Space(Ï†ïÏßÄ), +/-(ÏÜçÎèÑ)', 'system');
                controller.addLog('   - Ïπ¥Î©îÎùº: ÏûêÎèôÏúºÎ°ú MJPEG Ïä§Ìä∏Î¶¨Î∞ç', 'system');
            }, 100);
        });

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìúÏãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (window.robotController) {
                window.robotController.sendMotorCommand('stop');
                if (window.robotController.systemInfoInterval) {
                    clearInterval(window.robotController.systemInfoInterval);
                }
            }
        });
    </script>
</body>
</html>